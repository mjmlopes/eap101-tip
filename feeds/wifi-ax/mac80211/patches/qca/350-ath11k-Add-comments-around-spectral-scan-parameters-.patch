From 28e5e69ef426d4fa24129de1674149e15c156f04 Mon Sep 17 00:00:00 2001
From: Mario Lopes <ml@simonwunderlich.de>
Date: Tue, 31 May 2022 15:24:15 +0200
Subject: [PATCH] ath11k: Add comments around spectral scan parameters of
 interest

Signed-off-by: Mario Lopes <ml@simonwunderlich.de>
---
 drivers/net/wireless/ath/ath11k/spectral.c | 49 +++++++++++++---------
 drivers/net/wireless/ath/ath11k/wmi.h      | 46 ++++++++++++--------
 2 files changed, 58 insertions(+), 37 deletions(-)

diff --git a/drivers/net/wireless/ath/ath11k/spectral.c b/drivers/net/wireless/ath/ath11k/spectral.c
index 111ce52..9c8ce3a 100644
--- a/drivers/net/wireless/ath/ath11k/spectral.c
+++ b/drivers/net/wireless/ath/ath11k/spectral.c
@@ -236,25 +236,36 @@ static int ath11k_spectral_scan_config(struct ath11k *ar,
 	else
 		count = max_t(u16, 1, ar->spectral.count);
 
-	param.vdev_id = arvif->vdev_id;
-	param.scan_count = count;
-	param.scan_fft_size = ar->spectral.fft_size;
-	param.scan_period = ATH11K_WMI_SPECTRAL_PERIOD_DEFAULT;
-	param.scan_priority = ATH11K_WMI_SPECTRAL_PRIORITY_DEFAULT;
-	param.scan_gc_ena = ATH11K_WMI_SPECTRAL_GC_ENA_DEFAULT;
-	param.scan_restart_ena = ATH11K_WMI_SPECTRAL_RESTART_ENA_DEFAULT;
-	param.scan_noise_floor_ref = ATH11K_WMI_SPECTRAL_NOISE_FLOOR_REF_DEFAULT;
-	param.scan_init_delay = ATH11K_WMI_SPECTRAL_INIT_DELAY_DEFAULT;
-	param.scan_nb_tone_thr = ATH11K_WMI_SPECTRAL_NB_TONE_THR_DEFAULT;
-	param.scan_str_bin_thr = ATH11K_WMI_SPECTRAL_STR_BIN_THR_DEFAULT;
-	param.scan_wb_rpt_mode = ATH11K_WMI_SPECTRAL_WB_RPT_MODE_DEFAULT;
-	param.scan_rssi_rpt_mode = ATH11K_WMI_SPECTRAL_RSSI_RPT_MODE_DEFAULT;
-	param.scan_rssi_thr = ATH11K_WMI_SPECTRAL_RSSI_THR_DEFAULT;
-	param.scan_pwr_format = ATH11K_WMI_SPECTRAL_PWR_FORMAT_DEFAULT;
-	param.scan_rpt_mode = ATH11K_WMI_SPECTRAL_RPT_MODE_DEFAULT;
-	param.scan_bin_scale = ATH11K_WMI_SPECTRAL_BIN_SCALE_DEFAULT;
-	param.scan_dbm_adj = ATH11K_WMI_SPECTRAL_DBM_ADJ_DEFAULT;
-	param.scan_chn_mask = ATH11K_WMI_SPECTRAL_CHN_MASK_DEFAULT;
+/*
+* This is called when background and trigger words are sent to /sys/kernel/debug/ieee80211/phyXXXXX/ath11k/spectral_scan_ctl.
+* Most of the values comes from wmi.h while others depends on some conditions.
+* The variable param.vdev_id should be kept as is while others can be changed, depending on the desired outcome.
+* For the patch to be applied without issues, please do not add or remove lines to the patch file.
+*/
+
+	param.vdev_id = arvif->vdev_id; //
+	param.scan_count = count; //
+	param.scan_fft_size = ar->spectral.fft_size; //
+	param.scan_period = ATH11K_WMI_SPECTRAL_PERIOD_DEFAULT; //
+	param.scan_priority = ATH11K_WMI_SPECTRAL_PRIORITY_DEFAULT; //
+	param.scan_gc_ena = ATH11K_WMI_SPECTRAL_GC_ENA_DEFAULT; //
+	param.scan_restart_ena = ATH11K_WMI_SPECTRAL_RESTART_ENA_DEFAULT; //
+	param.scan_noise_floor_ref = ATH11K_WMI_SPECTRAL_NOISE_FLOOR_REF_DEFAULT; //
+	param.scan_init_delay = ATH11K_WMI_SPECTRAL_INIT_DELAY_DEFAULT; //
+	param.scan_nb_tone_thr = ATH11K_WMI_SPECTRAL_NB_TONE_THR_DEFAULT; //
+	param.scan_str_bin_thr = ATH11K_WMI_SPECTRAL_STR_BIN_THR_DEFAULT; //
+	param.scan_wb_rpt_mode = ATH11K_WMI_SPECTRAL_WB_RPT_MODE_DEFAULT; //
+	param.scan_rssi_rpt_mode = ATH11K_WMI_SPECTRAL_RSSI_RPT_MODE_DEFAULT; //
+	param.scan_rssi_thr = ATH11K_WMI_SPECTRAL_RSSI_THR_DEFAULT; //
+	param.scan_pwr_format = ATH11K_WMI_SPECTRAL_PWR_FORMAT_DEFAULT; //
+	param.scan_rpt_mode = ATH11K_WMI_SPECTRAL_RPT_MODE_DEFAULT; //
+	param.scan_bin_scale = ATH11K_WMI_SPECTRAL_BIN_SCALE_DEFAULT; //
+	param.scan_dbm_adj = ATH11K_WMI_SPECTRAL_DBM_ADJ_DEFAULT; //
+	param.scan_chn_mask = ATH11K_WMI_SPECTRAL_CHN_MASK_DEFAULT; //
+
+/*
+* This is just to mark the end of code of interest
+*/
 
 	ret = ath11k_wmi_vdev_spectral_conf(ar, &param);
 	if (ret) {
diff --git a/drivers/net/wireless/ath/ath11k/wmi.h b/drivers/net/wireless/ath/ath11k/wmi.h
index 44851dc..4d0364e 100644
--- a/drivers/net/wireless/ath/ath11k/wmi.h
+++ b/drivers/net/wireless/ath/ath11k/wmi.h
@@ -6153,24 +6153,34 @@ struct ath11k_wmi_pdev_lro_config_cmd {
 	u32 pdev_id;
 } __packed;
 
-#define ATH11K_WMI_SPECTRAL_COUNT_DEFAULT                 0
-#define ATH11K_WMI_SPECTRAL_PERIOD_DEFAULT              224
-#define ATH11K_WMI_SPECTRAL_PRIORITY_DEFAULT              1
-#define ATH11K_WMI_SPECTRAL_FFT_SIZE_DEFAULT              7
-#define ATH11K_WMI_SPECTRAL_GC_ENA_DEFAULT                1
-#define ATH11K_WMI_SPECTRAL_RESTART_ENA_DEFAULT           0
-#define ATH11K_WMI_SPECTRAL_NOISE_FLOOR_REF_DEFAULT     -96
-#define ATH11K_WMI_SPECTRAL_INIT_DELAY_DEFAULT           80
-#define ATH11K_WMI_SPECTRAL_NB_TONE_THR_DEFAULT          12
-#define ATH11K_WMI_SPECTRAL_STR_BIN_THR_DEFAULT           8
-#define ATH11K_WMI_SPECTRAL_WB_RPT_MODE_DEFAULT           0
-#define ATH11K_WMI_SPECTRAL_RSSI_RPT_MODE_DEFAULT         0
-#define ATH11K_WMI_SPECTRAL_RSSI_THR_DEFAULT           0xf0
-#define ATH11K_WMI_SPECTRAL_PWR_FORMAT_DEFAULT            0
-#define ATH11K_WMI_SPECTRAL_RPT_MODE_DEFAULT              2
-#define ATH11K_WMI_SPECTRAL_BIN_SCALE_DEFAULT             1
-#define ATH11K_WMI_SPECTRAL_DBM_ADJ_DEFAULT               1
-#define ATH11K_WMI_SPECTRAL_CHN_MASK_DEFAULT              1
+/*
+* Most of the Spectral Scan defaults can be found below and changed.
+* Some of them might not be used at all due to the code flow, please check the other comment on spectral.c.
+* For the patch to be applied without issues, please do not add or remove lines to the patch file.
+*/
+
+#define ATH11K_WMI_SPECTRAL_COUNT_DEFAULT                 0 //
+#define ATH11K_WMI_SPECTRAL_PERIOD_DEFAULT              224 //
+#define ATH11K_WMI_SPECTRAL_PRIORITY_DEFAULT              1 //
+#define ATH11K_WMI_SPECTRAL_FFT_SIZE_DEFAULT              7 //
+#define ATH11K_WMI_SPECTRAL_GC_ENA_DEFAULT                1 //
+#define ATH11K_WMI_SPECTRAL_RESTART_ENA_DEFAULT           0 //
+#define ATH11K_WMI_SPECTRAL_NOISE_FLOOR_REF_DEFAULT     -96 //
+#define ATH11K_WMI_SPECTRAL_INIT_DELAY_DEFAULT           80 //
+#define ATH11K_WMI_SPECTRAL_NB_TONE_THR_DEFAULT          12 //
+#define ATH11K_WMI_SPECTRAL_STR_BIN_THR_DEFAULT           8 //
+#define ATH11K_WMI_SPECTRAL_WB_RPT_MODE_DEFAULT           0 //
+#define ATH11K_WMI_SPECTRAL_RSSI_RPT_MODE_DEFAULT         0 //
+#define ATH11K_WMI_SPECTRAL_RSSI_THR_DEFAULT           0xf0 //
+#define ATH11K_WMI_SPECTRAL_PWR_FORMAT_DEFAULT            0 //
+#define ATH11K_WMI_SPECTRAL_RPT_MODE_DEFAULT              2 //
+#define ATH11K_WMI_SPECTRAL_BIN_SCALE_DEFAULT             1 //
+#define ATH11K_WMI_SPECTRAL_DBM_ADJ_DEFAULT               1 //
+#define ATH11K_WMI_SPECTRAL_CHN_MASK_DEFAULT              1 //
+
+/*
+* This is just to mark the end of code of interest
+*/
 
 struct ath11k_wmi_vdev_spectral_conf_param {
 	u32 vdev_id;
-- 
2.30.2

